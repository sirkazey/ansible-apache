<VirtualHost {{apache_host}}:443>
   ServerName {{url_token}}
   ServerPath /
   ServerSignature Off
   AllowEncodedSlashes NoDecode


# Section securisation apache2
  AccessFileName .httpdoverride
    <Files ~ "^\.ht">
      Order allow,deny
      Deny from all
    </Files>
    <Location />
      Order Deny,Allow
      Deny from All
    </Location>
    <Location "/azure/keystone/v2.0/tokens">
      Order Allow,Deny
      Allow from All
    </Location>
    <Location "/keystone/">
      Order Allow,Deny
      Allow from All
    </Location>
    <Location "/maintenance.html">
      Order Allow,Deny
      Allow from All
    </Location>
    <Location "/error.html">
      Order Allow,Deny
      Allow from All
    </Location>

# Section logs
   LogLevel debug ssl:trace8
   ErrorLog /var/log/cyris/error.token-{{ptf_name}}.log
   CustomLog /var/log/cyris/access.token-{{ptf_name}}.log combined


# Section SSL
   Protocol https
   SSLEngine on
   SSLCompression Off
   SSLCipherSuite HIGH:!aNULL:!MD5
   SSLHonorCipherOrder on
   SSLProtocol -All +TLSv1 +TLSv1.1 +TLSv1.2
   SSLCertificateFile {{SSLCertificateFile}}
   SSLCertificateChainFile {{SSLCertificateChainFile}}
   SSLCertificateKeyFile {{SSLCertificateKeyFile}}
   LimitRequestFields 100
   LimitRequestFieldSize 8190
   LimitRequestLine 8190

# Section Directives proxy
   ProxyPreserveHost On
   ProxyRequests On
   Header edit Location ^http://(.*)$ https://$1
   Header set Strict-Transport-Security "max-age=15552001; includeSubDomains"
   Header set Set-Cookie HttpOnly;Secure
   ProxyPass /maintenance.html !
   ProxyPass /error.html !
   ProxyPass / http://{{cyris_sts_externe}}/ retry=30
   ProxyPassReverse / http://{{cyris_sts_externe}}/
   RewriteEngine On
   RewriteCond %{HTTPS} off
   RewriteRule (.*) https://%{HTTP_HOST}

# Section Erreurs et maintenance
   RewriteEngine On
   RewriteCond %{ENV:REDIRECT_STATUS} !=503
   RewriteCond %{ENV:REDIRECT_STATUS} !=403
   RewriteCond %{ENV:REDIRECT_STATUS} !=404
   RewriteCond "/var/www/html/maintenance.html" -f
   RewriteCond "/var/www/html/maintenance.enable" -f
   RewriteRule ^(.*)$ /$1 [R=503,L]
   DocumentRoot /var/www/html
   ErrorDocument 503 /maintenance.html
   ErrorDocument 403 /error.html
   ErrorDocument 404 /error.html

# Section specifique a ce site
   <Location />
      SetEnv proxy-keepalive-sync 1
      SetEnv proxy-sendchunked 1
   </Location>
</VirtualHost>
